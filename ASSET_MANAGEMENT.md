# Asset Management - Anti-Hardcoding System

## ⚠️ NEVER HARDCODE ASSET FILENAMES AGAIN!

This document explains the permanent solution implemented to prevent webpack asset hardcoding issues.

## The Problem

Previously, the application suffered from hardcoded asset filenames in templates:
```html
<!-- BAD - NEVER DO THIS -->
<script src="/build/vendors-node_modules_fortawesome_vue-fontawesome_index_es_js-node_modules_bootstrap_dist_js_b-2d6d85.js"></script>
```

When webpack regenerated files with new hashes (e.g., `2d6d85` → `23b071`), the template still referenced the old filename, causing 404 errors.

## The Solution

### 1. Dynamic Asset Service (`src/Service/AssetService.php`)

This service automatically resolves webpack asset URLs by:
- Reading `entrypoints.json` to get current asset filenames
- Converting absolute URLs to relative paths for nginx proxy
- Providing fallback scanning of build directory if entrypoints.json fails

### 2. Twig Extension (`src/Twig/AssetExtension.php`)

Provides Twig functions:
- `webpack_js_assets()` - Returns array of JS asset URLs
- `webpack_css_assets()` - Returns array of CSS asset URLs

### 3. Smart Template (`templates/base.html.twig`)

```twig
<!-- GOOD - Dynamic loading without hardcoding -->
{% for cssFile in webpack_css_assets() %}
    <link rel="stylesheet" href="{{ cssFile }}">
{% endfor %}

{% for jsFile in webpack_js_assets() %}
    <script src="{{ jsFile }}" defer></script>
{% endfor %}
```

## How It Works

1. **Development Mode**: Reads `public/build/entrypoints.json` generated by webpack-dev-server
2. **Automatic URL Conversion**: Converts `http://localhost:8080/build/...` to `/build/...` for nginx proxy
3. **Fallback System**: If entrypoints.json is unavailable, scans build directory for assets
4. **Zero Hardcoding**: No asset filenames are ever hardcoded in templates

## Benefits

✅ **Future-Proof**: Works with any webpack hash changes  
✅ **Environment Agnostic**: Works in development, production, Docker  
✅ **Automatic**: No manual intervention needed when assets change  
✅ **Fallback Safe**: Multiple layers of fallback protection  
✅ **Performance**: Caches asset resolution  

## Configuration

The system is auto-configured in `config/services.yaml`:

```yaml
App\Service\AssetService:
    arguments:
        $projectDir: '%kernel.project_dir%'
```

## Testing

To verify the system is working:

```bash
# Check if assets are dynamically resolved
curl -s http://127.0.0.1:8090/ | grep -E "(script|link.*css)"

# Should show relative paths like:
# <script src="/build/runtime.js" defer></script>
# <script src="/build/vendors-node_modules_...-HASH.js" defer></script>
```

## Rules for Developers

### ✅ DO:
- Use `webpack_js_assets()` and `webpack_css_assets()` functions
- Let the system automatically resolve asset URLs
- Trust the fallback mechanisms

### ❌ NEVER DO:
- Hardcode asset filenames in templates
- Reference specific webpack hashes
- Use `encore_entry_script_tags()` in Docker environments (generates wrong URLs)
- Manually specify vendor file names

## Troubleshooting

If assets are not loading:

1. **Check entrypoints.json**: `curl http://127.0.0.1:8090/build/entrypoints.json`
2. **Check build directory**: `ls -la public/build/`
3. **Check service logs**: `docker-compose logs php`
4. **Verify nginx proxy**: Assets should be accessible via `/build/` path

## Future Webpack Changes

This system automatically adapts to:
- New webpack versions
- Changed asset hashing algorithms  
- Different chunk splitting strategies
- New vendor dependencies
- Build configuration changes

**No manual updates needed - ever!** 